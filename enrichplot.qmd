# Visualization of functional enrichment result {#enrichplot}


```{r}
#| echo: false
#| message: false
#| cache: false

source("_common.R")
library(clusterProfiler)
library(enrichplot)
```



The `r Biocpkg("enrichplot")` package implements several visualization methods to help interpreting enrichment results. It supports visualizing enrichment results obtained from `r Biocpkg("DOSE")` [@yu_dose_2015], `r Biocpkg("clusterProfiler")` [@yu2012; @wu_clusterprofiler_2021],
`r Biocpkg("ReactomePA")` [@yu_reactomepa_2016] and `r Biocpkg("meshes")` [@yu_meshes_2018]. Both over representation analysis (ORA) and gene set enrichment analysis (GSEA) are supported.

Note: Several visualization methods were first implemented in `r Biocpkg("DOSE")` and rewrote from scratch using `r CRANpkg("ggplot2")`. If you want to use the [old methods](https://www.biostars.org/p/375555), you can use the [doseplot](https://github.com/GuangchuangYu/doseplot) package.


## Bar Plot


Bar plot is the most widely used method to visualize enriched terms. It depicts the enrichment scores (*e.g.* p values) and gene count or ratio as bar height
and color @fig-Barplot. Users can specify the number of terms (most significant) or selected terms (see also the [FAQ](#showing-specific-pathways)) to display via the `showCategory` parameter. 



```{r}
library(DOSE)
data(geneList)
de <- names(geneList)[abs(geneList) > 2]

edo <- enrichDGN(de)
```

```{r eval=F}
library(enrichplot)
barplot(edo, showCategory=20) 
```

Other variables that derived using `mutate` can also be used as bar height or color as demonstrated in @sec-mutate and @fig-Barplot.

```{r eval=F}
library(clusterProfiler)

mutate(edo, qscore = -log(p.adjust, base=10)) |> 
    barplot(x="qscore")
```



```{r Barplot}
#| label: fig-Barplot  
#| echo: false
#| fig-width: 11
#| fig-height: 6
#| fig-scap: |
#|   Bar plot of enriched terms.
#| fig-cap: |
#|   **Bar plot of enriched terms.**

p1 <- barplot(edo, showCategory=20) 
p2 <- mutate(edo, qscore = -log(p.adjust, base=10)) |>
    barplot(x="qscore")

library(aplot)
plot_list(p1, p2, ncol=2, tag_levels='A')    
```


## Dot plot


Dot plot is similar to bar plot with the capability to encode another score as dot size.

```r
library(ggplot2)
edo2 <- gseDO(geneList)
dotplot(edo, showCategory=30) + ggtitle("dotplot for ORA")
dotplot(edo2, showCategory=30) + ggtitle("dotplot for GSEA")
```


```{r}
#| label: fig-Dotplotcap  
#| echo: false
#| fig-width: 12
#| fig-height: 10
#| fig-scap: |
#|   Dot plot of enriched terms.
#| fig-cap: |
#|   **Dot plot of enriched terms.**
library(ggplot2)

edo2 <- gseDO(geneList)
p1 <- dotplot(edo, showCategory=30) + ggtitle("dotplot for ORA") 
p2 <- dotplot(edo2, showCategory=30) + ggtitle("dotplot for GSEA") 
plot_list(p1, p2, ncol=2, tag_levels = 'A')
```


Note: The `dotplot()` function also works with [`compareCluster()` output](##compare-dotplot).


## Gene-Concept Network {#cnetplot}

Both the `barplot()` and `dotplot()` only displayed most significant or selected enriched terms,
while users may want to know which genes are involved in these significant
terms. 
In order to consider the potentially biological complexities in which a gene may belong to multiple annotation categories and provide information of numeric changes if available, we developed the `cnetplot()` function to extract the complex association. 
The `cnetplot()` depicts the linkages of genes and biological concepts (*e.g.* GO terms or KEGG pathways) as a network. GSEA result is also supported
with only core enriched genes displayed.


```{r}
#| label: fig-Networkplot  
#| fig-width: 20
#| fig-height: 10
#| fig-scap: |
#|   Network plot of enriched terms.
#| fig-cap: |
#|   **Network plot of enriched terms.**
#| 
## convert gene ID to Symbol
edox <- setReadable(edo, 'org.Hs.eg.db', 'ENTREZID')
p1 <- cnetplot(edox, foldChange=geneList)
## categorySize can be scaled by 'pvalue' or 'geneNum'
p2 <- cnetplot(edox, categorySize="pvalue", foldChange=geneList)
p3 <- cnetplot(edox, foldChange=geneList, circular = TRUE, colorEdge = TRUE) 
plot_list(p1, p2, p3, ncol=3, tag_levels = 'A', widths = c(.8, .8, 1.2))
```




If you would like label subset of the nodes, you can use the `node_label` parameter, which supports 4 possible selections (i.e. "category", "gene", "all" and "none"), as demonstrated in @fig-cnetNodeLabel. 



```{r}
#| label: fig-cnetNodeLabel  
#| fig-width: 12
#| fig-height: 16
#| fig-scap: |
#|   Labelling nodes by selected subset.
#| fig-cap: |
#|   **Labelling nodes by selected subset.** 
#|   gene category (A), gene name (B), 
#|   both gene category and gene name (C, default) 
#|   and not to label at all (D).
p1 <- cnetplot(edox, node_label="category") 
p2 <- cnetplot(edox, node_label="gene") 
p3 <- cnetplot(edox, node_label="all") 
p4 <- cnetplot(edox, node_label="none", 
        color_category='firebrick', 
        color_gene='steelblue') 
plot_list(p1, p2, p3, p4, ncol=2, tag_levels = 'A')
```

The `cnetplot` function can be used as a general method to visualize data relationships in a network diagram. Users can use a named list as input as demonstrated in @fig-cnetplotgeneral. 


```{r}
#| label: fig-cnetplotgeneral  
#| fig-width: 8.3
#| fig-height: 4.8
#| fig-scap: |
#|   Using `cnetplot` to visualize data relationships.
#| fig-cap: |
#|   **Using `cnetplot` to visualize data relationships.** 
#|   relationships as a network diagram (A) 
#|   and with associated data to color nodes (B).
set.seed(123)
x <- list(A = letters[1:10], B=letters[5:12], C=letters[sample(1:26, 15)])
p1 <- cnetplot(x)

set.seed(123)
d <- setNames(rnorm(26), letters)
p2 <- cnetplot(x, foldChange=d) + 
    scale_color_gradient2(name='associated data', low='darkgreen', high='firebrick')

plot_list(p1, p2, ncol=2, tag_levels = 'A')    
```


Note: The `cnetplot()` function also works with [`compareCluster()` output](##compare-cnetplot).


## Heatmap-like functional classification


The `heatplot` is similar to `cnetplot`, while displaying the relationships as a
heatmap. The gene-concept network may become too complicated if user want to
show a large number significant terms. The `heatplot` can simplify the result
and more easy to identify expression patterns.

```{r}
#| label: fig-Heatplot  
#| fig-width: 12
#| fig-height: 5
#| fig-scap: |
#|   Heatmap plot of enriched terms.
#| fig-cap: |
#|   **Heatmap plot of enriched terms.** 
#|   default (A), `foldChange=geneList` (B)

p1 <- heatplot(edox, showCategory=5)
p2 <- heatplot(edox, foldChange=geneList, showCategory=5)
plot_list(p1, p2, ncol=1, tag_levels = 'A')
```


## Tree plot

The `treeplot()` function performs hierarchical clustering of enriched terms. It relies on the pairwise similarities of the enriched terms calculated by the `pairwise_termsim()` function, which by default using Jaccard's similarity index (JC). Users can also use semantic similarity values if it is supported (*e.g.*, [GO](#GOSemSim), [DO](#DOSE-semantic-similarity) and [MeSH](#meshes-semantic-similarity)).


The default agglomeration method in `treeplot()` is `ward.D` and users can specify other methods via the `cluster_method` parameter (*e.g.*, 'average', 'complete', 'median', 'centroid', *etc.*, see also the document of the `hclust()` function). The `treeplot()` function will cut the tree into several subtrees (specify by the `nCluster` parameter (default is 5)) and labels subtrees using high-frequency words. This will reduce the complexity of the enriched result and improve user interpretation ability.



```{r}
#| label: fig-treeplot  
#| fig-width: 14
#| fig-height: 6
#| fig-scap: |
#|   Tree plot of enriched terms.
#| fig-cap: |
#|   **Tree plot of enriched terms.** 
#|   default (A), `hclust_method = "average"` (B)
edox2 <- pairwise_termsim(edox)
p1 <- treeplot(edox2)
p2 <- treeplot(edox2, cluster_method = "average")
aplot::plot_list(p1, p2, tag_levels='A')
```


## Enrichment Map


Enrichment map organizes enriched terms into a network with edges connecting
overlapping gene sets. In this way, mutually overlapping gene sets are tend to
cluster together, making it easy to identify functional module.

The `emapplot` function supports results obtained from hypergeometric test and gene set enrichment analysis. The `size_category` parameter can be used to resize nodes and the `layout` parameter can adjust the layout, as demonstrated in @fig-Enrichment.



```{r}
#| label: fig-Enrichment  
#| fig-width: 16
#| fig-height: 14
#| fig-scap: |
#|   Plot for results obtained from hypergeometric test and gene set enrichment analysis.
#| fig-cap: |
#|   **Plot for results obtained from hypergeometric test and gene set enrichment analysis.**
#|   default (A), `size_category=1.5` (B), `layout="kk"` (C) and
#|   `size_category=1.5,layout="kk"` (D).
edo <- pairwise_termsim(edo)
p1 <- emapplot(edo)
p2 <- emapplot(edo, size_category=1.5)
p3 <- emapplot(edo, layout="kk")
p4 <- emapplot(edo, size_category=1.5,layout="kk") 
plot_list(p1, p2, p3, p4, ncol=2, tag_levels = 'A')
```


## Biological theme comparison 

The `emapplot` function also supports results obtained from `compareCluster` function of `clusterProfiler` package. In addition to `size_category` and `layout` parameters, the number of circles in the bottom left corner can be adjusted  using the `legend_n` parameteras, and proportion of clusters in the pie chart can be adjusted using the `pie` parameter, when `pie="count"`, the proportion of  clusters in the pie chart is determined by the number of genes, as demonstrated in @fig-Enrichment2.


(ref:Enrichment2scap) 

(ref:Enrichment2cap) 

```{r}
#| label: fig-Enrichment2  
#| fig-width: 16
#| fig-height: 18
#| fig-scap: |
#|   Plot for results obtained from `compareCluster` function of `clusterProfiler` package.
#| fig-cap: |
#|   **Plot for results obtained from `compareCluster` function of `clusterProfiler` package.** 
#|   default (A), `legend_n=2` (B), `pie="count"` (C) and `pie="count",
#|   size_category=1.5, layout="kk"` (D).
library(clusterProfiler)
data(gcSample)
xx <- compareCluster(gcSample, fun="enrichKEGG",
                     organism="hsa", pvalueCutoff=0.05)
xx <- pairwise_termsim(xx)                     
p1 <- emapplot(xx)
p2 <- emapplot(xx) 
p3 <- emapplot(xx, pie="count")
p4 <- emapplot(xx, pie="count", size_category=1.5, layout="kk")
plot_list(p1, p2, p3, p4, ncol=2, tag_levels = 'A')
```


## UpSet Plot


The `upsetplot` is an alternative to `cnetplot` for visualizing the complex
association between genes and gene sets. It emphasizes the gene overlapping
among different gene sets.


```{r}
#| label: fig-upsetORA  
#| fig-width: 12
#| fig-height: 5
#| fig-scap: |
#|   Upsetplot for over-representation analysis.
#| fig-cap: |
#|   **Upsetplot for over-representation analysis.** 
upsetplot(edo)
```

For over-representation analysis, `upsetplot` will calculate the overlaps among different gene sets as demonstrated in @fig-upsetORA. For GSEA result, it will plot the fold change distributions of different categories (e.g. unique to pathway, overlaps among different pathways).


(ref:upsetGSEAscap) 

(ref:upsetGSEAcap) 

```{r}
#| label: fig-upsetGSEA  
#| fig-width: 12
#| fig-height: 5
#| fig-scap: |
#|   Upsetplot for gene set enrichment analysis.
#| fig-cap: |
#|   **Upsetplot for gene set enrichment analysis.** 
kk2 <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               minGSSize    = 120,
               pvalueCutoff = 0.05,
               verbose      = FALSE)
upsetplot(kk2) 
```


## ridgeline plot for expression distribution of GSEA result

The `ridgeplot` will visualize expression distributions of core enriched genes
for GSEA enriched categories. It helps users to interpret up/down-regulated pathways.


```{r}
#| label: fig-ridgeplot  
#| fig-width: 12
#| fig-height: 8
#| fig-scap: |
#|   Ridgeplot for gene set enrichment analysis.
#| fig-cap: |
#|   **Ridgeplot for gene set enrichment analysis.** 
ridgeplot(edo2)
```


## running score and preranked list of GSEA result

Running score and preranked list are traditional methods for visualizing GSEA
result. The `r Biocpkg("enrichplot")` package supports both of them to visualize
the distribution of the gene set and the enrichment score.


```{r}
#| label: fig-gseaplot  
#| fig-width: 12
#| fig-height: 16
#| fig-scap: |
#|   gseaplot for GSEA result(`by = "runningScore"`).
#| fig-cap: |
#|   **gseaplot for GSEA result(`by = "runningScore"`).** 
#|   `by = "runningScore"` (A), `by = "preranked"` (B), default (C)
p1 <- gseaplot(edo2, geneSetID = 1, by = "runningScore", title = edo2$Description[1])
p2 <- gseaplot(edo2, geneSetID = 1, by = "preranked", title = edo2$Description[1])
p3 <- gseaplot(edo2, geneSetID = 1, title = edo2$Description[1])
plot_list(p1, p2, p3, ncol=1, tag_levels='A')
```


Another method to plot GSEA result is the `gseaplot2` function:


```{r}
#| label: fig-gseaplot2  
#| fig-width: 12
#| fig-height: 8
#| fig-scap: |
#|   Gseaplot2 for GSEA result.
#| fig-cap: |
#|   **Gseaplot2 for GSEA result.** 
gseaplot2(edo2, geneSetID = 1, title = edo2$Description[1])
```

The `gseaplot2` also supports multile gene sets to be displayed on the same figure:


```{r}
#| label: fig-gseaplot22  
#| fig-width: 12
#| fig-height: 8
#| fig-scap: |
#|   Gseaplot2 for GSEA result of multile gene sets.
#| fig-cap: |
#|   **Gseaplot2 for GSEA result of multile gene sets.** 
gseaplot2(edo2, geneSetID = 1:3)
```

User can also displaying the pvalue table on the plot via `pvalue_table`
parameter:


```{r}
#| label: fig-gseaplot23  
#| fig-width: 12
#| fig-height: 8
#| fig-scap: |
#|   Gseaplot2 for GSEA result of multile gene sets(add pvalue_table).
#| fig-cap: |
#|   **Gseaplot2 for GSEA result of multile gene sets(add pvalue_table).** 
gseaplot2(edo2, geneSetID = 1:3, pvalue_table = TRUE,
          color = c("#E495A5", "#86B875", "#7DB0DD"), ES_geom = "dot")
```


User can specify `subplots` to only display a subset of plots:


```{r}
#| label: fig-gseaplot24
#| fig-width: 12
#| fig-height: 8
#| fig-scap: |
#|   Gseaplot2 for GSEA result of multile gene sets(add subplots).
#| fig-cap: |
#|   **Gseaplot2 for GSEA result of multile gene sets(add subplots).** 
#|   `subplots = 1` (A),`subplots = 1:2` (B)
#| 
p1 <- gseaplot2(edo2, geneSetID = 1:3, subplots = 1)
p2 <- gseaplot2(edo2, geneSetID = 1:3, subplots = 1:2)
plot_list(p1, p2, ncol=1, tag_levels = 'A')
```



The `gsearank` function plot the ranked list of genes belong to the specific
gene set.


```{r}
#| label: fig-gsearank
#| fig-width: 12
#| fig-height: 8
#| fig-scap: |
#|   Ranked list of genes belong to the specific gene set.
#| fig-cap: |
#|   **Ranked list of genes belong to the specific gene set.**
gsearank(edo2, 1, title = edo2[1, "Description"])
```

Multiple gene sets can be aligned using `cowplot`:

```{r}
#| label: fig-gsearank2
#| fig-width: 8
#| fig-height: 12
#| fig-scap: |
#|   Gsearank for multiple gene sets.
#| fig-cap: |
#|   **Gsearank for multiple gene sets.**
#| 
library(ggplot2)

pp <- lapply(1:3, function(i) {
    anno <- edo2[i, c("NES", "pvalue", "p.adjust")]
    lab <- paste0(names(anno), "=",  round(anno, 3), collapse="\n")

    gsearank(edo2, i, edo2[i, 2]) + xlab(NULL) +ylab(NULL) +
        annotate("text", 10000, edo2[i, "enrichmentScore"] * .75, label = lab, hjust=0, vjust=0)
})
plot_list(gglist=pp, ncol=1)
```



## pubmed trend of enriched terms

One of the problem of enrichment analysis is to find pathways for further
investigation. Here, we provide `pmcplot` function to plot the number/proportion
of publications trend based on the query result from PubMed Central. Of course,
users can use `pmcplot` in other scenarios. All text that can be queried on PMC
is valid as input of `pmcplot`.


```{r}
#| label: fig-pmcplot
#| fig-width: 14
#| fig-height: 6
#| fig-scap: |
#|   Pmcplot of enrichment analysis.
#| fig-cap: |
#|   **Pmcplot of enrichment analysis.**
#| 
terms <- edo$Description[1:5]
p <- pmcplot(terms, 2010:2020)
p2 <- pmcplot(terms, 2010:2020, proportion=FALSE)
plot_list(p, p2, ncol=2)
```



<!--

using ggplot2 api

`[` accessor


ggplot(egobp[1:20], aes(x=reorder(Description, -pvalue), y=Count, fill=-p.adjust)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    scale_fill_continuous(low="blue", high="red") +
    labs(x = "", y = "", fill = "p.adjust") +
    theme(axis.text=element_text(size=11))

-->

## References {-}
